#!/bin/zsh

# clone - A wrapper around git clone that integrates with git-url and follows directory conventions

# Check if git-url is available
if ! command -v git-url &> /dev/null; then
	cat >&2 <<EOF
Error: git-url command not found

The git-clone plugin requires the git-url plugin to be installed.

To install using Antigen, add this to your .antigenrc BEFORE loading git-clone:

    antigen bundle rwinch/zsh-plugins --loc=git-url

For more information, see:
    https://github.com/rwinch/zsh-plugins/tree/main/git-url
    https://github.com/rwinch/zsh-plugins/tree/main/git-clone

EOF
	exit 1
fi

# Function to extract owner and repository from a git URL
extract_owner_and_repo() {
	local url="$1"
	local owner=""
	local repo=""
	local path=""

	# Handle SSH format: git@host:owner/repo.git
	if [[ "$url" == git@*:*.git ]]; then
		# Remove git@host: prefix
		path="${url#git@*:}"
		# Remove .git suffix
		path="${path%.git}"
		# Split on /
		owner="${path%%/*}"
		repo="${path#*/}"
	# Handle HTTPS format: https://host/owner/repo.git
	elif [[ "$url" == http*://*.git ]]; then
		# Remove https://host/ or http://host/ prefix
		path="${url#http*://}"
		path="${path#*/}"
		# Remove .git suffix
		path="${path%.git}"
		# Split on /
		owner="${path%%/*}"
		repo="${path#*/}"
	fi

	# Output owner and repo on separate lines
	printf "%s\n%s\n" "$owner" "$repo"
}

# Separate git-url arguments from git clone arguments
git_url_args=()
git_clone_args=()
skip_next=false

for arg in "$@"; do
	if [[ "$skip_next" == true ]]; then
		git_url_args+=("$arg")
		skip_next=false
		continue
	fi

	case "$arg" in
		--https|--gitlab|--help)
			git_url_args+=("$arg")
			;;
		--host|--owner|--repository)
			git_url_args+=("$arg")
			skip_next=true
			;;
		-*)
			# All other flags go to git clone
			git_clone_args+=("$arg")
			;;
		*)
			# Check if it looks like an owner/repo slug or URL (for git-url)
			if [[ "$arg" =~ ^[^/]+/[^/]+$ ]] || [[ "$arg" =~ ^git@.+:.+\.git$ ]] || [[ "$arg" =~ ^https?://.+\.git$ ]]; then
				git_url_args+=("$arg")
			else
				# Otherwise it's for git clone (e.g., directory name)
				git_clone_args+=("$arg")
			fi
			;;
	esac
done

# Handle --help specially
if [[ " ${git_url_args[@]} " =~ " --help " ]]; then
	cat <<EOF
Usage: clone [GIT-URL-OPTIONS] [GIT-CLONE-OPTIONS]

A wrapper around git clone that integrates with git-url and follows directory conventions.

GIT-URL OPTIONS (passed to git-url to generate repository URL):
  --https              Use HTTPS URL format instead of SSH (default: SSH)
  --host HOST          Specify the Git host domain (default: github.com)
  --gitlab             Shortcut for --host gitlab.com
  --owner OWNER        Override the repository owner
  --repository REPO    Override the repository name
  OWNER/REPOSITORY     GitHub slug in the format owner/repository
  URL                  Full SSH or HTTPS URL

GIT-CLONE OPTIONS (passed to git clone):
  Any other options are passed directly to git clone (e.g., --branch, --depth, etc.)

BEHAVIOR:
  - Checks if ~/code/OWNER/REPOSITORY already exists before cloning
  - If exists, changes directory to ~/code/OWNER/REPOSITORY/BRANCH (main, master, or root)
  - Clones into ~/code/OWNER/REPOSITORY/main initially
  - Renames directory to actual default branch if different from 'main'
  - Sets remote name to OWNER instead of 'origin'
  - Changes directory to ~/code/OWNER/REPOSITORY/BRANCH after cloning

EXAMPLES:
  clone spring-projects/spring-security
  clone --https spring-projects/spring-security
  clone --gitlab mygroup/myproject
  clone spring-projects/spring-security --depth 1
  clone --branch 5.8.x spring-projects/spring-security

EOF
	exit 0
fi

# Get the URL from git-url
url=$(git-url "${git_url_args[@]}")
exit_code=$?

if [[ $exit_code -ne 0 ]]; then
	echo "Error: Failed to generate URL from git-url" >&2
	exit $exit_code
fi

# Extract owner and repository from the URL
result=$(extract_owner_and_repo "$url")
lines=("${(@f)result}")
owner="${lines[1]}"
repo="${lines[2]}"

if [[ -z "$owner" || -z "$repo" ]]; then
	echo "Error: Could not extract owner and repository from URL: $url" >&2
	exit 1
fi

# Check if the repository already exists
base_dir="$HOME/code/$owner/$repo"

if [[ -d "$base_dir" ]]; then
	echo "Repository already exists at $base_dir"
	
	# Try to change to main, master, or base directory
	if [[ -d "$base_dir/main" ]]; then
		echo "Changing directory to $base_dir/main"
		cd "$base_dir/main" || exit 1
	elif [[ -d "$base_dir/master" ]]; then
		echo "Changing directory to $base_dir/master"
		cd "$base_dir/master" || exit 1
	else
		echo "Changing directory to $base_dir"
		cd "$base_dir" || exit 1
	fi
	
	exit 0
fi

# Create parent directory structure
mkdir -p "$HOME/code/$owner"

# Clone into main directory initially
clone_dir="$base_dir/main"
echo "Cloning $url into $clone_dir with remote name '$owner'"

# Clone with owner as remote name
command git clone --origin "$owner" "${git_clone_args[@]}" "$url" "$clone_dir"
clone_exit=$?

if [[ $clone_exit -ne 0 ]]; then
	echo "Error: git clone failed" >&2
	exit $clone_exit
fi

# Determine the actual default branch
cd "$clone_dir" || exit 1
actual_branch=$(git symbolic-ref refs/remotes/$owner/HEAD 2>/dev/null | sed "s@^refs/remotes/$owner/@@")

if [[ -z "$actual_branch" ]]; then
	# Fallback: try to get the current branch
	actual_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
fi

if [[ -z "$actual_branch" ]]; then
	echo "Warning: Could not determine default branch, assuming 'main'"
	actual_branch="main"
fi

# Rename directory if the actual branch is different from 'main'
if [[ "$actual_branch" != "main" ]]; then
	new_dir="$base_dir/$actual_branch"
	echo "Renaming directory to match default branch: $actual_branch"
	cd "$HOME/code/$owner" || exit 1
	mv "main" "$actual_branch"
	cd "$new_dir" || exit 1
	echo "Changed directory to $new_dir"
else
	echo "Changed directory to $clone_dir"
fi

exit 0

