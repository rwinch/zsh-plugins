#!/bin/zsh

# Default values
use_https=false
host="github.com"
owner=""
repository=""
gh_slug=""

# Usage function
usage() {
	cat <<EOF
Usage: git-url [OPTIONS] [OWNER/REPOSITORY | URL]

Generate GitHub repository URLs based on the current directory or provided arguments.

OPTIONS:
  --https              Use HTTPS URL format instead of SSH (default: SSH)
  --host HOST          Specify the Git host domain (default: github.com)
  --gitlab             Shortcut for --host gitlab.com
  --owner OWNER        Override the repository owner
  --repository REPO    Override the repository name
  --help               Display this help message

OPTIONAL ARGUMENTS:
  OWNER/REPOSITORY     GitHub slug in the format owner/repository
  URL                  Full SSH or HTTPS URL from any Git host (will be echoed back unchanged)

BEHAVIOR:
  - By default, generates SSH URL: git@HOST:OWNER/REPOSITORY.git
  - With --https flag, generates HTTPS URL: https://HOST/OWNER/REPOSITORY.git
  - Default host is github.com, but can be changed with --host or --gitlab
  - If inside ~/code directory structure, automatically detects owner and repository
    from the directory path (~/code/OWNER/REPOSITORY/...)
  - If a full URL is provided (SSH or HTTPS from any Git host), it is returned unchanged

EXAMPLES:
  git-url                          # Auto-detect from ~/code/owner/repo/...
  git-url --https                  # Auto-detect with HTTPS URL
  git-url spring-projects/spring-security
  git-url --https spring-projects/spring-security
  git-url --gitlab mygroup/myproject
  git-url --host gitlab.com --https mygroup/myproject
  git-url --host bitbucket.org myteam/myrepo
  git-url --owner myorg --repository myrepo
  git-url --repository myrepo --owner myorg --https
  git-url git@github.com:spring-projects/spring-security.git
  git-url https://github.com/spring-projects/spring-security.git
  git-url git@gitlab.com:mygroup/myproject.git
  git-url https://bitbucket.org/myteam/myrepo.git

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
	case $1 in
		--https)
			use_https=true
			shift
			;;
		--host)
			if [[ -z "$2" || "$2" == --* ]]; then
				echo "Error: --host requires a value" >&2
				echo "" >&2
				usage
				exit 1
			fi
			host="$2"
			shift 2
			;;
		--gitlab)
			host="gitlab.com"
			shift
			;;
		--owner)
			if [[ -z "$2" || "$2" == --* ]]; then
				echo "Error: --owner requires a value" >&2
				echo "" >&2
				usage
				exit 1
			fi
			owner="$2"
			shift 2
			;;
		--repository)
			if [[ -z "$2" || "$2" == --* ]]; then
				echo "Error: --repository requires a value" >&2
				echo "" >&2
				usage
				exit 1
			fi
			repository="$2"
			shift 2
			;;
		--help)
			usage
			exit 0
			;;
		--*)
			echo "Error: Unknown option: $1" >&2
			echo "" >&2
			usage
			exit 1
			;;
		*)
			# Positional argument (gh_slug)
			gh_slug="$1"
			shift
			;;
	esac
done

# Parse gh_slug if provided
if [[ -n "$gh_slug" ]]; then
	# Check if it's a full SSH URL (git@host:path/to/repo.git or ssh://git@host/path/to/repo.git)
	if [[ "$gh_slug" =~ ^git@[^:]+:.+\.git$ ]] || [[ "$gh_slug" =~ ^ssh://[^/]+/.+\.git$ ]]; then
		echo "$gh_slug"
		exit 0
	# Check if it's a full HTTPS URL (https://host/path/to/repo.git)
	elif [[ "$gh_slug" =~ ^https?://[^/]+/.+\.git$ ]]; then
		echo "$gh_slug"
		exit 0
	# Check if it's an owner/repository slug
	elif [[ "$gh_slug" =~ ^([^/]+)/([^/]+)$ ]]; then
		slug_owner="${match[1]}"
		slug_repository="${match[2]}"
		
		# gh_slug sets defaults, but explicit flags override
		if [[ -z "$owner" ]]; then
			owner="$slug_owner"
		fi
		if [[ -z "$repository" ]]; then
			repository="$slug_repository"
		fi
	else
		echo "Error: Invalid argument format. Expected: OWNER/REPOSITORY or full URL" >&2
		echo "" >&2
		usage
		exit 1
	fi
fi

# Auto-detect from ~/code directory structure if not set
if [[ -z "$owner" || -z "$repository" ]]; then
	pwd=$(pwd)
	code_dir="$HOME/code"
	
	# Check if we're inside ~/code
	if [[ "$pwd" == "$code_dir"/* ]]; then
		# Remove the ~/code prefix
		relative_path="${pwd#$code_dir/}"
		
		# Extract owner (first directory after ~/code)
		if [[ -z "$owner" ]]; then
			owner=$(echo "$relative_path" | cut -d'/' -f1)
		fi
		
		# Extract repository (second directory after ~/code)
		if [[ -z "$repository" ]]; then
			repository=$(echo "$relative_path" | cut -d'/' -f2)
		fi
	fi
fi

# Validate that we have both owner and repository
if [[ -z "$owner" || -z "$repository" ]]; then
	echo "Error: Could not determine owner and repository" >&2
	echo "Please provide them via arguments or run from within ~/code/OWNER/REPOSITORY/" >&2
	echo "" >&2
	usage
	exit 1
fi

# Generate and output the URL
if [[ "$use_https" == true ]]; then
	echo "https://${host}/${owner}/${repository}.git"
else
	echo "git@${host}:${owner}/${repository}.git"
fi

