pwd=$(pwd)
owner=$(basename $(dirname $(dirname $(pwd))))
repo=$(basename $(dirname $(pwd)))
current_branch=$(git rev-parse --abbrev-ref HEAD)
current_user=$(gh api user -q .login)

merge_prs() {
	local pr_json="$1"
	local number=$(echo "$pr_json" | jq -r '.number')
	local title=$(echo "$pr_json" | jq -r '.title')
	local url=$(echo "$pr_json" | jq -r '.url')
	
	# Check if all status checks have conclusion of SUCCESS or SKIPPED
	local failed_checks=$(echo "$pr_json" | jq -r '[.statusCheckRollup[] | select(.conclusion != "SUCCESS" and .conclusion != "SKIPPED")] | length')
	
	if [ "$failed_checks" -gt 0 ]; then
		local failed_names=$(echo "$pr_json" | jq -r '[.statusCheckRollup[] | select(.conclusion != "SUCCESS" and .conclusion != "SKIPPED") | .name] | join(", ")')
		echo "‚è≠Ô∏è  Skipping $url - $failed_checks check(s) not passed: $failed_names"
		return
	fi
	
	# Set assignee to current GitHub user
	gh pr edit $number --add-assignee "$current_user"
	
	open $url
	echo "Merging $url"
	gh pr checkout -f $url
	git checkout -
	git merge -m "$title" -
	
	if [ $? -ne 0 ]; then
		echo ""
		echo "‚ùå Merge conflict detected for: $title"
		echo "üìù URL: $url"
		echo ""
		
		# Loop until merge is resolved or user continues/aborts
		while true; do
			echo "Please resolve the merge conflict and press Enter to validate..."
			echo "(Or enter 'C' to continue anyway, Ctrl+C to abort)"
			read -r response
			
			# Check if user wants to continue anyway
			if [ "$response" = "C" ] || [ "$response" = "c" ]; then
				echo "‚ö†Ô∏è  Continuing without validation..."
				break
			fi
			
		# Check if merge was completed successfully
		if git diff --quiet && git diff --cached --quiet; then
			# Check if we're still in a merge state
			if [ -f "$(git rev-parse --git-path MERGE_HEAD)" ]; then
				echo ""
				echo "‚ö†Ô∏è  Merge is still in progress. Please complete the merge:"
				echo "   1. Resolve conflicts in the files"
				echo "   2. Run: git add <resolved-files>"
				echo "   3. Run: git commit"
				echo ""
			else
				echo ""
				echo "‚ö†Ô∏è  No staged changes detected and no active merge."
				echo "    Make sure you've resolved and committed the merge."
				echo ""
			fi
		else
			# There are changes, check if merge is complete
			if [ -f "$(git rev-parse --git-path MERGE_HEAD)" ]; then
				echo ""
				echo "‚ö†Ô∏è  Merge is still in progress. Please complete the merge:"
				echo "   1. Stage resolved files: git add <resolved-files>"
				echo "   2. Commit the merge: git commit"
				echo ""
			else
				echo "‚úÖ Merge completed successfully! Continuing with next PR..."
				break
			fi
		fi
		done
	else
		echo "‚úÖ Merged successfully: $title"
	fi
}

# Process PRs from dependabot[bot]
while read -r pr_json; do
	merge_prs "$pr_json"
done < <(gh pr list --repo "$owner/$repo" --base "$current_branch" --author 'dependabot[bot]' --label "type: dependency-upgrade" --state open --json number,title,url,statusCheckRollup | jq -c '.[]')

# Process PRs from github-actions[bot]
while read -r pr_json; do
	merge_prs "$pr_json"
done < <(gh pr list --repo "$owner/$repo" --base "$current_branch" --author 'github-actions[bot]' --state open --json number,title,url,statusCheckRollup | jq -c '.[]')
